class Solution {
public:
    vector<int> countMentions(int numberOfUsers, vector<vector<string>>& events) {
        // sort by timestamp asc; at same timestamp OFFLINE before MESSAGE
        sort(events.begin(), events.end(),
             [](const vector<string>& a, const vector<string>& b) {
                 int t1 = stoi(a[1]);
                 int t2 = stoi(b[1]);
                 if (t1 != t2) return t1 < t2;
                 int p1 = (a[0] == "OFFLINE" ? 0 : 1);
                 int p2 = (b[0] == "OFFLINE" ? 0 : 1);
                 return p1 < p2;
             });

        vector<int> mentions(numberOfUsers, 0);
        // -1 => currently online; otherwise stores offline start timestamp
        vector<int> offlineStart(numberOfUsers, -1);

        for (auto &ev : events) {
            const string &type = ev[0];
            int t = stoi(ev[1]);

            if (type == "OFFLINE") {
                int id = stoi(ev[2]);
                // user goes offline starting at t for 60 units: [t, t+60)
                offlineStart[id] = t;
            } else { // MESSAGE
                const string &body = ev[2];
                if (body == "ALL") {
                    // ALL mentions all users regardless of online/offline
                    for (int i = 0; i < numberOfUsers; ++i) mentions[i]++;
                } else if (body == "HERE") {
                    // HERE mentions all users who are online at time t
                    for (int i = 0; i < numberOfUsers; ++i) {
                        if (isOnlineAt(offlineStart[i], t)) mentions[i]++;
                    }
                } else {
                    // id tokens (may contain duplicates)
                    vector<int> ids = extractIds(body);
                    for (int id : ids) {
                        // id mentions count even if user offline
                        if (0 <= id && id < numberOfUsers) mentions[id]++;
                    }
                }
            }
        }
        return mentions;
    }

private:
    // returns true if user is online at time t
    bool isOnlineAt(int offlineStart, int t) {
        if (offlineStart == -1) return true;
        // offline interval is [offlineStart, offlineStart+60)
        if (t >= offlineStart && t < offlineStart + 60) return false;
        return true;
    }

    // parse tokens like "id0 id1 3" -> {0,1,3}
    vector<int> extractIds(const string& line) {
        vector<int> res;
        string token;
        stringstream ss(line);
        while (ss >> token) {
            if (token.rfind("id", 0) == 0) {
                string num = token.substr(2);
                if (!num.empty() && all_of(num.begin(), num.end(), ::isdigit))
                    res.push_back(stoi(num));
            } else if (!token.empty() && all_of(token.begin(), token.end(), ::isdigit)) {
                res.push_back(stoi(token));
            }
        }
        return res;
    }
};
